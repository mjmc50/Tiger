<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TigerStream - AI Moderated Jungle</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        :root { --tiger-orange: #ff8c00; --tiger-black: #000000; --stripe: #1a1a1a; }
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; background: var(--tiger-black); color: white; 
            font-family: 'Arial Black', sans-serif; height: 100vh; overflow: hidden;
            background-image: linear-gradient(45deg, var(--stripe) 25%, transparent 25%, transparent 50%, var(--stripe) 50%, var(--stripe) 75%, transparent 75%, transparent);
            background-size: 60px 60px;
        }

        #authOverlay { 
            position: fixed; inset: 0; background: black; z-index: 9999; 
            display: flex; align-items: center; justify-content: center;
        }
        .auth-box { 
            background: #222; border: 6px solid var(--tiger-orange); 
            padding: 40px; border-radius: 20px; text-align: center; width: 400px; 
        }
        .auth-box input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid var(--tiger-orange); background: #111; color: white; }

        nav { 
            height: 60px; background: var(--tiger-orange); border-bottom: 4px solid black;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .logo { color: black; font-size: 1.5rem; }
        #searchBar { width: 40%; padding: 8px; border: 2px solid black; border-radius: 5px; font-weight: bold; }

        .split-container { display: flex; height: calc(100vh - 60px); }
        .column { 
            flex: 1; display: flex; flex-direction: column; 
            border-right: 4px solid var(--tiger-orange); overflow: hidden;
            background: rgba(0,0,0,0.6);
        }
        .column:last-child { border-right: none; }
        .col-header { 
            background: #222; padding: 15px; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 2px solid var(--tiger-orange);
        }
        .scroll-area { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: thin; scrollbar-color: var(--tiger-orange) #000; }

        .card { background: #111; border: 3px solid var(--tiger-orange); border-radius: 15px; margin-bottom: 30px; overflow: hidden; }
        video { width: 100%; display: block; background: #000; }
        .column:nth-child(2) video { aspect-ratio: 9/16; } 
        .column:nth-child(1) video { aspect-ratio: 16/9; } 
        
        .info { padding: 12px; }
        .info h4 { margin: 0 0 10px 0; color: var(--tiger-orange); }
        .btn-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-group button { background: var(--tiger-orange); border: none; padding: 5px 10px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        
        .comments { background: #000; padding: 8px; border-radius: 5px; font-size: 0.8rem; max-height: 80px; overflow-y: auto; color: #ccc; }
        .comment-input { width: 100%; background: #222; color: white; border: 1px solid #444; padding: 8px; margin-top: 8px; border-radius: 4px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; }
        .modal-box { background: #222; border: 5px solid var(--tiger-orange); padding: 25px; width: 380px; display: flex; flex-direction: column; gap: 15px; border-radius: 20px; }
        .post-btn { background: var(--tiger-orange); color: black; border: none; padding: 12px; cursor: pointer; font-weight: bold; border-radius: 8px; }
        .post-btn:disabled { background: #444; color: #888; cursor: not-allowed; }
        #aiStatus { font-size: 0.75rem; color: #ffcc00; font-family: sans-serif; }
    </style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-box">
        <h1 style="color:var(--tiger-orange)">TIGER ID</h1>
        <p>This device is locked. Create an account to enter.</p>
        <input type="text" id="regUser" placeholder="Username">
        <input type="password" id="regPass" placeholder="Password">
        <button class="post-btn" onclick="registerDevice()">CREATE & LOCK DEVICE</button>
        <p id="authMsg" style="color:red; font-size: 0.8rem; margin-top:10px;"></p>
    </div>
</div>

<nav>
    <div class="logo"><strong>üêÖ TIGERSTREAM</strong></div>
    <input type="text" id="searchBar" placeholder="Hunt for videos..." oninput="searchContent()">
    <div id="userTag" style="color:black; font-weight:bold; background:white; padding:5px 10px; border-radius:5px;">User</div> 
</nav>

<div class="split-container">
    <div class="column">
        <div class="col-header">
            <span style="color: var(--tiger-orange);">MAIN JUNGLE</span>
            <button class="post-btn" style="padding: 5px 10px;" onclick="openModal('video')">POST VIDEO</button>
        </div>
        <div class="scroll-area" id="videoGrid"></div>
    </div>

    <div class="column">
        <div class="col-header">
            <span style="color: #ffcc00;">SHORTS (MAX 35s)</span>
            <button class="post-btn" style="padding: 5px 10px; background:#ffcc00;" onclick="openModal('short')">POST SHORT</button>
        </div>
        <div class="scroll-area" id="shortsGrid"></div>
    </div>
</div>

<div id="uploadModal" class="modal">
    <div class="modal-box">
        <h2 id="modalTitle" style="margin:0; color:var(--tiger-orange);">UPLOAD</h2>
        <div id="aiStatus">AI Status: Waiting for video...</div>
        <label>Select Video (NO PHOTOS):</label>
        <input type="file" id="fileIn" accept="video/*" onchange="runAIModeration()">
        <label>Video Name:</label>
        <input type="text" id="titleIn" placeholder="Enter title...">
        <button id="submitBtn" class="post-btn" onclick="processUpload()" disabled>SCANNING REQUIRED...</button>
        <button onclick="closeModal()" style="background:none; color:#777; border:none; cursor:pointer;">Cancel</button>
    </div>
</div>

<script>
    let contentStore = JSON.parse(localStorage.getItem('tiger_split_final')) || [];
    let userAccount = JSON.parse(localStorage.getItem('tiger_account')) || null;
    let activeType = 'video';
    let model = null;

    cocoSsd.load().then(res => {
        model = res;
        document.getElementById('aiStatus').innerText = "AI System: ONLINE";
    });

    window.onload = () => {
        if (userAccount) {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('userTag').innerText = userAccount.username.toUpperCase();
            renderFeeds();
        }
    };

    function registerDevice() {
        const u = document.getElementById('regUser').value.trim();
        const p = document.getElementById('regPass').value;
        const msg = document.getElementById('authMsg');
        const banned = ["explicit", "nude", "porn", "admin", "sex"];
        if (u.length < 3) return msg.innerText = "Username too short!";
        if (banned.some(word => u.toLowerCase().includes(word))) return msg.innerText = "AI REJECTED: Inappropriate Username!";
        if (u && p) {
            userAccount = { username: u, password: p };
            localStorage.setItem('tiger_account', JSON.stringify(userAccount));
            location.reload();
        }
    }

    function openModal(type) { 
        activeType = type;
        document.getElementById('modalTitle').innerText = "NEW " + type.toUpperCase();
        document.getElementById('uploadModal').style.display = 'flex'; 
    }
    
    function closeModal() { 
        document.getElementById('uploadModal').style.display = 'none'; 
        document.getElementById('fileIn').value = '';
        document.getElementById('titleIn').value = '';
        document.getElementById('submitBtn').disabled = true;
    }

    async function runAIModeration() {
        const file = document.getElementById('fileIn').files[0];
        const status = document.getElementById('aiStatus');
        const btn = document.getElementById('submitBtn');

        if (!file || !file.type.startsWith('video/')) {
            alert("GRRR! NO PHOTOS! Videos only.");
            document.getElementById('fileIn').value = '';
            return;
        }

        status.innerText = "AI scanning activity (Fights & Content Allowed)...";
        status.style.color = "yellow";
        btn.disabled = true;

        const tempVid = document.createElement('video');
        tempVid.src = URL.createObjectURL(file);
        tempVid.muted = true;

        tempVid.onloadeddata = async () => {
            const scanPoints = [0.2, 0.5, 0.8]; 
            let passedPoints = 0;

            for (let point of scanPoints) {
                tempVid.currentTime = tempVid.duration * point;
                await new Promise(r => setTimeout(r, 600));
                const predictions = await model.detect(tempVid);
                if (predictions.length > 0) passedPoints++;
            }

            if (passedPoints > 0) {
                status.innerText = "AI Passed: Activity Verified.";
                status.style.color = "lime";
                btn.disabled = false;
                btn.innerText = "RELEASE THE BEAST";
            } else {
                status.innerText = "AI Rejected: Inappropriate or Empty Content.";
                status.style.color = "red";
                btn.innerText = "REJECTED";
            }
        };
    }

    function processUpload() {
        const file = document.getElementById('fileIn').files[0];
        const title = document.getElementById('titleIn').value;
        if (!title) return alert("Title required!");
        const tempVid = document.createElement('video');
        tempVid.src = URL.createObjectURL(file);
        tempVid.onloadedmetadata = function() {
            if (activeType === 'short' && tempVid.duration > 35) {
                alert("TOO LONG! Shorts must be 35s or less.");
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                contentStore.push({
                    id: Date.now(), type: activeType, title: title,
                    src: e.target.result, author: userAccount.username,
                    likes: 0, dislikes: 0, comments: []
                });
                localStorage.setItem('tiger_split_final', JSON.stringify(contentStore));
                renderFeeds(); closeModal();
            };
            reader.readAsDataURL(file);
        };
    }

    function renderFeeds(list = contentStore) {
        const vGrid = document.getElementById('videoGrid');
        const sGrid = document.getElementById('shortsGrid');
        vGrid.innerHTML = ''; sGrid.innerHTML = '';
        [...list].reverse().forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<video controls src="${item.src}"></video>
                <div class="info">
                    <h4>${item.title}</h4>
                    <p style="font-size:0.7rem; color:gray">Posted by: ${item.author}</p>
                    <div class="btn-group">
                        <button onclick="vote(${item.id}, 'likes')">üëç ${item.likes}</button>
                    </div>
                    <div class="comments">${item.comments.map(c => `<div>üêæ ${c}</div>`).join('')}</div>
                    <input class="comment-input" placeholder="Roar..." onkeydown="addComment(event, ${item.id})">
                </div>`;
            if(item.type === 'video') vGrid.appendChild(card);
            else sGrid.appendChild(card);
        });
    }

    function vote(id, key) {
        const item = contentStore.find(i => i.id === id);
        item[key]++;
        localStorage.setItem('tiger_split_final', JSON.stringify(contentStore));
        renderFeeds();
    }

    function addComment(e, id) {
        if (e.key === 'Enter' && e.target.value) {
            contentStore.find(i => i.id === id).comments.push(e.target.value);
            localStorage.setItem('tiger_split_final', JSON.stringify(contentStore));
            renderFeeds();
        }
    }

    function searchContent() {
        const query = document.getElementById('searchBar').value.toLowerCase();
        renderFeeds(contentStore.filter(i => i.title.toLowerCase().includes(query)));
    }
    renderFeeds();
</script>
</body>
</html>
