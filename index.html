<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildlife: Total Repair</title>
    <style>
        :root { --glow: #00ff41; --dim: #003b00; --bg: #050505; --text: #00ff41; --panel: rgba(0, 20, 0, 0.9); --border: #00ff41; --error: #ff3333; }
        .theme-white { --glow: #007bff; --dim: #e7f1ff; --bg: #ffffff; --text: #333333; --panel: #f1f1f1; --border: #007bff; }
        body, html { margin: 0; padding: 0; min-height: 100vh; background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; transition: 0.3s; overflow-x: hidden; }
        body::after { content: " "; display: block; position: fixed; inset: 0; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%); z-index: 9999; background-size: 100% 3px; pointer-events: none; }
        
        #forest-nav, #game-trigger { position: fixed; top: 15px; z-index: 9000; cursor: pointer; font-size: 35px; filter: drop-shadow(0 0 5px var(--glow)); }
        #forest-nav { left: 15px; } #game-trigger { right: 15px; }
        
        #command-center { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9001; align-items: center; justify-content: center; }
        .menu-box { background: var(--bg); border: 2px solid var(--border); padding: 25px; width: 95%; max-width: 500px; display: flex; flex-direction: column; gap: 8px; }
        
        .module-window { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 9005; padding: 40px 20px; overflow-y: auto; }
        .close-mod { position: absolute; top: 15px; right: 25px; font-size: 30px; cursor: pointer; color: var(--error); }
        
        #feed { max-width: 600px; margin: 80px auto; padding: 10px; }
        .card { border: 1px solid var(--border); margin-bottom: 25px; background: var(--panel); padding: 15px; position: relative; }
        
        input, textarea { background: #000; border: 1px solid var(--dim); color: var(--glow); padding: 12px; width: 100%; box-sizing: border-box; font-family: inherit; margin: 5px 0; }
        .btn { border: 1px solid var(--border); background: transparent; color: var(--text); padding: 10px; cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 0.75rem;}
        .btn:hover { background: var(--border); color: #000; }
        
        .list-item { border-bottom: 1px solid var(--dim); padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        #game-canvas-container { display: none; flex-direction: column; align-items: center; justify-content: center; position: fixed; inset: 0; background: #000; z-index: 11000; }
    </style>
</head>
<body>

<div id="forest-nav" onclick="openMenu()">üå≤</div>
<div id="game-trigger" onclick="toggleGame()">üéÆ</div>

<div id="auth-screen">
    <div class="menu-box">
        <h2 style="text-align:center;">WILDLIFE_V5.6</h2>
        <p style="font-size:0.7rem; color:orange; text-align:center;">[ NO PASSWORD | DEVICE LOCK ACTIVE ]</p>
        <input id="u" placeholder="USERNAME">
        <label style="font-size:0.7rem;">MANDATORY BIRTHDAY:</label>
        <input id="d" type="date" required>
        <button class="btn" onclick="handleAuth()">ACCESS SYSTEM</button>
    </div>
</div>

<div id="main-ui" style="display:none;"><div id="feed"></div></div>

<div id="command-center">
    <div class="menu-box">
        <button class="btn" onclick="openMod('dm-mod')">1. [DMs] MESSAGES</button>
        <button class="btn" onclick="openMod('create-forest-mod')">2. [NEW FOREST] CREATE</button>
        <button class="btn" onclick="openMod('search-mod')">3. [SEARCH] USERS / REQS</button>
        <button class="btn" onclick="openMod('friends-mod')">4. [FRIENDS] CONTACTS</button>
        <button class="btn" onclick="openMod('self-mod')">5. [PROFILE] SELF</button>
        <button class="btn" onclick="openMod('other-mod')">6. [RECON] SCAN</button>
        <button class="btn" onclick="openMod('settings-mod')">7. [SETTINGS] STATS</button>
        <button class="btn" onclick="openMod('search-forest-mod')">8. [EXPLORE] FORESTS</button>
        <button class="btn" onclick="closeMenu()" style="border-color:gray; color:gray;">[ CLOSE ]</button>
    </div>
</div>

<div id="dm-mod" class="module-window"><span class="close-mod" onclick="closeMod('dm-mod')">√ó</span><h3>[ DMs ]</h3><input id="dm-target" placeholder="Recipient..."><textarea id="dm-text" placeholder="Message..."></textarea><button class="btn" onclick="sendDM()">SEND</button><div id="dm-list"></div></div>
<div id="create-forest-mod" class="module-window"><span class="close-mod" onclick="closeMod('create-forest-mod')">√ó</span><h3>[ CREATE FOREST ]</h3><input id="f-name" placeholder="Forest Name..."><button class="btn" onclick="createForest()">CREATE</button></div>
<div id="search-mod" class="module-window"><span class="close-mod" onclick="closeMod('search-mod')">√ó</span><h3>[ USER SEARCH ]</h3><div id="req-box"></div><input id="search-input" oninput="doSearch()" placeholder="Search..."><div id="search-results"></div></div>
<div id="friends-mod" class="module-window"><span class="close-mod" onclick="closeMod('friends-mod')">√ó</span><h3>[ FRIENDS ]</h3><div id="friends-list"></div></div>
<div id="self-mod" class="module-window"><span class="close-mod" onclick="closeMod('self-mod')">√ó</span><h3>[ MY PROFILE ]</h3><div id="self-data"></div><textarea id="bio-input"></textarea><button class="btn" onclick="saveBio()">SAVE BIO</button></div>
<div id="other-mod" class="module-window"><span class="close-mod" onclick="closeMod('other-mod')">√ó</span><h3>[ RECON ]</h3><input id="recon-target" placeholder="Username..."><button class="btn" onclick="reconUser()">SCAN</button><div id="recon-result"></div></div>
<div id="settings-mod" class="module-window"><span class="close-mod" onclick="closeMod('settings-mod')">√ó</span><h3>[ SYSTEM ]</h3><button class="btn" onclick="toggleTheme()">TOGGLE THEME</button><div id="stats-area"></div></div>
<div id="search-forest-mod" class="module-window"><span class="close-mod" onclick="closeMod('search-forest-mod')">√ó</span><h3>[ EXPLORE ]</h3><input id="forest-search-input" oninput="doForestSearch()" placeholder="Find Forest..."><div id="forest-search-results"></div></div>

<div id="game-canvas-container"><span class="close-mod" onclick="toggleGame()">√ó</span><canvas id="game-screen" width="400" height="200"></canvas><button class="btn" onclick="startGame()">START RUN</button></div>

<script>
    const BIN_ID = '69609cd1ae596e708fcf605f', KEY = '$2a$10$sGFP1dkFd/v7sGKtbL3XLOYw0jsKRMUNIgsTU/iwij0XnwUAeJPWy';
    let db = { posts: [], accounts: [], dms: [], forests: [] }, me = null;

    function getFingerprint() { return navigator.userAgent + screen.width; }
    async function sync() { const r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: {'X-Master-Key': KEY, 'X-Bin-Meta': 'false'}}); db = await r.json(); }
    async function save() { await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { method: 'PUT', headers: {'Content-Type': 'application/json', 'X-Master-Key': KEY}, body: JSON.stringify(db)}); }

    // AUTH
    window.handleAuth = async () => {
        const user = document.getElementById('u').value.trim();
        const bday = document.getElementById('d').value;
        if(!user || !bday) return alert("USERNAME AND BIRTHDAY ARE MANDATORY.");
        
        const fp = getFingerprint();
        await sync();
        let acc = db.accounts.find(a => a.user === user);

        if(acc) {
            if(acc.fingerprint !== fp) return alert("DEVICE LOCK: ACCESS DENIED.");
            me = acc;
        } else {
            const age = Math.floor((new Date() - new Date(bday)) / 31557600000);
            if(age < 13 || age > 16) return alert("AGE ERROR (13-16 ONLY)");
            me = { user, fingerprint: fp, bio: "Entity.", friends: [], requests: [], joined: Date.now() };
            db.accounts.push(me); await save();
        }
        localStorage.setItem('jungle_v5.6', JSON.stringify(me));
        location.reload();
    };

    // MENU CONTROLS
    window.openMenu = () => { document.getElementById('command-center').style.display='flex'; };
    window.closeMenu = () => { document.getElementById('command-center').style.display='none'; };
    window.openMod = (id) => {
        closeMenu();
        document.querySelectorAll('.module-window').forEach(w => w.style.display='none');
        document.getElementById(id).style.display='block';
        if(id === 'search-mod') renderSearch();
        if(id === 'dm-mod') renderDMs();
        if(id === 'friends-mod') renderFriends();
        if(id === 'search-forest-mod') renderForests();
        if(id === 'self-mod') { document.getElementById('self-data').innerHTML = `USER: ${me.user}`; document.getElementById('bio-input').value = me.bio; }
    };
    window.closeMod = (id) => { document.getElementById(id).style.display='none'; };

    // BUTTON FUNCTIONS (FIXED SCOPE)
    window.sendDM = async () => {
        const t = document.getElementById('dm-target').value, m = document.getElementById('dm-text').value;
        db.dms.push({ from: me.user, to: t, text: m }); await save(); renderDMs();
    };
    function renderDMs() { document.getElementById('dm-list').innerHTML = db.dms.filter(d => d.to === me.user || d.from === me.user).map(d => `<div class="list-item"><b>${d.from}:</b> ${d.text}</div>`).join(''); }

    window.createForest = async () => {
        const n = document.getElementById('f-name').value;
        db.forests.push({ name: n, creator: me.user }); await save(); alert("CREATED");
    };

    window.doSearch = () => {
        const v = document.getElementById('search-input').value.toLowerCase();
        document.getElementById('search-results').innerHTML = db.accounts.filter(a => a.user.toLowerCase().includes(v) && a.user !== me.user).map(r => `
            <div class="list-item">${r.user} <button class="btn" onclick="sendReq('${r.user}')">REQ</button></div>
        `).join('');
    };

    window.sendReq = async (name) => {
        await sync(); let t = db.accounts.find(a => a.user === name);
        if(!t.requests.includes(me.user)) { t.requests.push(me.user); await save(); alert("SENT"); }
    };

    function renderSearch() {
        const myAcc = db.accounts.find(a => a.user === me.user);
        document.getElementById('req-box').innerHTML = (myAcc.requests || []).map(r => `
            <div class="list-item" style="color:gold;">REQ FROM: ${r} <button class="btn" onclick="acceptFriend('${r}')">ACCEPT</button></div>
        `).join('');
    }

    window.acceptFriend = async (name) => {
        await sync(); let my = db.accounts.find(a => a.user === me.user); let thr = db.accounts.find(a => a.user === name);
        my.requests = my.requests.filter(x => x !== name);
        my.friends.push(name); thr.friends.push(me.user);
        await save(); location.reload();
    };

    window.doForestSearch = () => {
        const v = document.getElementById('forest-search-input').value.toLowerCase();
        document.getElementById('forest-search-results').innerHTML = db.forests.filter(f => f.name.toLowerCase().includes(v)).map(f => `<div class="list-item">üå≤ ${f.name}</div>`).join('');
    };
    function renderForests() { document.getElementById('forest-search-results').innerHTML = db.forests.map(f => `<div class="list-item">üå≤ ${f.name}</div>`).join(''); }

    window.renderFriends = () => { document.getElementById('friends-list').innerHTML = me.friends.map(f => `<div class="list-item">${f}</div>`).join(''); };

    window.saveBio = async () => {
        db.accounts.find(a => a.user === me.user).bio = document.getElementById('bio-input').value;
        await save(); alert("BIO SAVED");
    };

    window.reconUser = () => {
        const u = db.accounts.find(x => x.user === document.getElementById('recon-target').value);
        document.getElementById('recon-result').innerHTML = u ? `<div class="card">${u.user}<br>${u.bio}</div>` : 'NOT FOUND';
    };

    window.toggleTheme = () => document.body.classList.toggle('theme-white');

    // FEED
    window.addPost = async () => {
        const t = prompt("T:"), u = prompt("U:");
        if(t && u) { db.posts.unshift({ id: Date.now(), author: me.user, title: t, url: u, stars: 0, likes: 0 }); await save(); renderFeed(); }
    };
    window.interact = async (id) => { db.posts.find(x => x.id === id).likes++; await save(); renderFeed(); };

    function renderFeed() {
        document.getElementById('feed').innerHTML = db.posts.map(p => `
            <div class="card">
                <small>${p.author}</small><br>
                <a href="${p.url}" target="_blank" style="color:var(--glow)">‚ñ∂ VIEW</a>
                <h3>${p.title}</h3>
                <button class="btn" onclick="interact(${p.id})">üëç ${p.likes}</button>
                ${me.user === 'mjmc50' ? `<button class="btn" style="color:red" onclick="erase(${p.id})">X</button>` : ''}
            </div>`).join('');
    }
    window.erase = async (id) => { db.posts = db.posts.filter(p => p.id !== id); await save(); renderFeed(); };

    // GAME (Mini version)
    window.toggleGame = () => { let g = document.getElementById('game-canvas-container'); g.style.display = g.style.display==='flex'?'none':'flex'; };
    window.startGame = () => { alert("CLICK TO JUMP! AVOID [X]"); /* Game loop simplified for scope */ };

    window.onload = async () => {
        const saved = localStorage.getItem('jungle_v5.6');
        if(saved) {
            me = JSON.parse(saved); document.getElementById('auth-screen').style.display='none';
            document.getElementById('main-ui').style.display='block'; await sync(); renderFeed();
        }
    };
</script>
</body>
</html>
